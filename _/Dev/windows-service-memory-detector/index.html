<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Windows服务内存监听 | BLOG</title><meta name="description" content="Development. 面白いこと. Game life."><meta name="keywords" content="Blog,Development.,面白いこと.,Game life."><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><link rel="shortcut icon" href="/favicon.ico"><link rel="alternate" href="/atom.xml" title="BLOG"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="起因一大早上班的时候，发现 chrome 浏览网页很卡，试着回收一下CommandChrome Commands1Chrome:://restart注: 此命令会关闭隐私窗口, 不能恢复…等 Chrome 重启之后，结果依然很卡…那就废话不多说，直接开大(Win + R)1C:\Users\User&amp;gt; taskmgr发现是本地的 gitblit 居然吃了我 40w+的内存，这个明显不能忍啊，"><meta name="keywords" content="CSharp,Windows"><meta property="og:type" content="article"><meta property="og:title" content="Windows服务内存监听"><meta property="og:url" content="http://yoursite.com/_/Dev/windows-service-memory-detector/index.html"><meta property="og:site_name" content="BLOG"><meta property="og:description" content="起因一大早上班的时候，发现 chrome 浏览网页很卡，试着回收一下CommandChrome Commands1Chrome:://restart注: 此命令会关闭隐私窗口, 不能恢复…等 Chrome 重启之后，结果依然很卡…那就废话不多说，直接开大(Win + R)1C:\Users\User&amp;gt; taskmgr发现是本地的 gitblit 居然吃了我 40w+的内存，这个明显不能忍啊，"><meta property="og:locale" content="en"><meta property="og:image" content="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAZCAMAAAAc9R5vAAAAElBMVEWBlKoA/wAAgAD///+AgIAAAAA34p8fAAAAJklEQVR4AWMYBIAFAZhRJViZYBBNggkOBkAHIxwMgAQzAjAMRQAAFFIBeToXnQgAAAAASUVORK5CYII="><meta property="og:image" content="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAZCAMAAAAc9R5vAAAAElBMVEUAAAAAgAAA/wCAgICBlKr///8XGZNTAAAAK0lEQVR4AWNgwQHoKMGMAKyoEgyMMIgmwQgHQ1sHExwQK8GKADhDdzBLAACjcwgSt1J0wAAAAABJRU5ErkJggg=="><meta property="og:updated_time" content="2019-07-15T09:48:03.778Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Windows服务内存监听"><meta name="twitter:description" content="起因一大早上班的时候，发现 chrome 浏览网页很卡，试着回收一下CommandChrome Commands1Chrome:://restart注: 此命令会关闭隐私窗口, 不能恢复…等 Chrome 重启之后，结果依然很卡…那就废话不多说，直接开大(Win + R)1C:\Users\User&amp;gt; taskmgr发现是本地的 gitblit 居然吃了我 40w+的内存，这个明显不能忍啊，"><meta name="twitter:image" content="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAZCAMAAAAc9R5vAAAAElBMVEWBlKoA/wAAgAD///+AgIAAAAA34p8fAAAAJklEQVR4AWMYBIAFAZhRJViZYBBNggkOBkAHIxwMgAQzAjAMRQAAFFIBeToXnQgAAAAASUVORK5CYII="><link rel="stylesheet" href="/style.css"><link rel="stylesheet" href="/css/waves.min.css"><script>function setLoadingBarProgress(e){document.getElementById("loading-bar").style.width=e+"%"}</script></head></html><body><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>setLoadingBarProgress(20)</script><header class="l_header"><div class="wrapper"><div class="nav-main container container--flex"><a class="logo flat-box" href="/">BLOG</a><div class="menu"><ul class="h-list"><li><a class="flat-box nav-home" href="/">Home</a></li></ul><div class="underline"></div></div><div class="m_search"><form name="searchform" class="form u-search-form"><input type="text" class="input u-search-input" placeholder="Search"> <span class="icon icon-search"></span></form></div><ul class="switcher h-list"><li class="s-search"><a href="javascript:void(0)"><span class="icon icon-search flat-box"></span></a></li><li class="s-menu"><a href="javascript:void(0)"><span class="icon icon-menu flat-box"></span></a></li></ul></div><div class="nav-sub container container--flex"><a class="logo" href="javascript:void(0)">Word of Forks</a><ul class="switcher h-list"><li class="s-comment"><a href="javascript:void(0)"><span class="icon icon-chat_bubble_outline flat-box"></span></a></li><li class="s-top"><a href="javascript:void(0)"><span class="icon icon-arrow_upward flat-box"></span></a></li><li class="s-toc"><a href="javascript:void(0)"><span class="icon icon-format_list_numbered flat-box"></span></a></li></ul></div></div></header><aside class="menu-phone"><nav><a href="/" class="nav-home nav">Home</a></nav></aside><script>setLoadingBarProgress(40)</script><div class="l_body"><div class="container clearfix"><div class="l_main"><article id="post-Dev/windows-service-memory-detector" class="post white-box article-type-post" itemscope itemprop="blogPost"><section class="meta"><h2 class="title"><a href="/_/Dev/windows-service-memory-detector/">Windows服务内存监听</a></h2><time>2019-05-22</time><div class="cats"><a href="/categories/foo系编程/">foo系编程</a></div></section><section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#起因"><span class="toc-number">1.</span> <span class="toc-text">起因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#想法"><span class="toc-number">2.</span> <span class="toc-text">想法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目说明："><span class="toc-number">3.</span> <span class="toc-text">项目说明：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#起主要作用的Class"><span class="toc-number">3.1.</span> <span class="toc-text">起主要作用的Class</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#源码"><span class="toc-number">3.2.</span> <span class="toc-text">源码</span></a></li></ol></li></ol></section><section class="article typo"><div class="article-entry" itemprop="articleBody"><h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>一大早上班的时候，发现 chrome 浏览网页很卡，试着回收一下<br></p><figure class="highlight plain"><figcaption><span>Command</span><a href="https://www.webnots.com/useful-chrome-url-commands/" target="_blank" rel="noopener">Chrome Commands</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Chrome:://restart</span><br></pre></td></tr></table></figure><p></p><blockquote><p>注: 此命令会关闭隐私窗口, 不能恢复…</p></blockquote><p>等 Chrome 重启之后，结果依然很卡…那就废话不多说，直接开大(<strong>Win + R</strong>)<br></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">User</span>&gt; <span class="title">taskmgr</span></span></span><br></pre></td></tr></table></figure><p></p><p>发现是本地的 <a href="http://gitblit.com/" target="_blank" rel="noopener">gitblit</a> 居然吃了我 <strong>40w+</strong>的内存，这个明显不能忍啊，直接给它来一套: <strong>net stop gitblit</strong><br>只听 TaskManager 这样给我说：<img class="base64-inline" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAZCAMAAAAc9R5vAAAAElBMVEWBlKoA/wAAgAD///+AgIAAAAA34p8fAAAAJklEQVR4AWMYBIAFAZhRJViZYBBNggkOBkAHIxwMgAQzAjAMRQAAFFIBeToXnQgAAAAASUVORK5CYII="> =&gt; <img class="base64-inline" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAZCAMAAAAc9R5vAAAAElBMVEUAAAAAgAAA/wCAgICBlKr///8XGZNTAAAAK0lEQVR4AWNgwQHoKMGMAKyoEgyMMIgmwQgHQ1sHExwQK8GKADhDdzBLAACjcwgSt1J0wAAAAABJRU5ErkJggg=="><br>看来它已经懂我意思了</p><h2 id="想法"><a href="#想法" class="headerlink" title="想法"></a>想法</h2><p>突然灵光一闪，我能不能做一个自动检查服务内存，到了一定的阈值自动关闭呢？<br>感觉是一个好想法，那就实现简单实现一下吧…<br>经过一段时间的捣腾，火光四溅之后，代码已经打包压缩好了，链接在文末</p><h2 id="项目说明："><a href="#项目说明：" class="headerlink" title="项目说明："></a>项目说明：</h2><p>我使用的是 Microsoft Visual Studio 2017(version 15.9.11)<br>如果使用较低版本的朋友，可以直接打开里层目录的 <code>.csproj</code> 文件</p><h3 id="起主要作用的Class"><a href="#起主要作用的Class" class="headerlink" title="起主要作用的Class"></a>起主要作用的Class</h3><ol><li><p><code>ServiceController</code> 位于 <code>System.ServiceProcess</code> 命名空间下，需要手动添加引用</p><blockquote><p>这个类主要用于获取当前所有的Services，使用静态方法 <code>GetServices</code> 就能拿到所有的服务<br>其中包括所有状态(Stopped、StartPending、StopPending、Running、ContinuePending、PausePending、Paused)<br>还有 <code>ServiceType</code> 之分，详情请查阅 <code>Enum</code> - <code>System.ServiceProcess.ServiceType</code></p></blockquote></li><li><p><code>PerformanceCounter</code> 它住在 <code>System.Diagnostics</code>，引入命名空间即可</p><blockquote><p>内存使用量的查询主要用到了它，这个类的构造函数第一个需要传入 <code>categoryName</code>，这个分类存在很多<br>具体可在 <code>性能监视器</code> 查看，<a href="https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.performancecounter?view=netframework-4.5.2" target="_blank" rel="noopener">附上官网的例子</a>，也可以使用 <code>perfmon</code> 查看，使用 <code>Win + R</code> 输入即可</p></blockquote></li><li><p>还有就是 <code>ManagementObjectSearcher</code> 住在 <code>System.Management</code> 也需要手动添加</p><blockquote><p>使用过 <code>WMI</code> 的应该都知道，简单点说就是如果你需要电脑的硬件信息，那很大可能你都会使用到它<br>在项目中主要用于查询某个 <code>Service</code> 相关联的 <code>ProcessId</code>，因为服务的名称是可以自定义的<br>运行的程序有可能名字不相同，所以需要去查询一下对应的Process</p></blockquote></li></ol><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><p><a href="./ServiceMemoryDetector.7z">Download</a></p></div><div class="article-tags tags"><a href="/tags/CSharp/">CSharp</a> <a href="/tags/Windows/">Windows</a></div><div class="art-item-footer"><span class="art-item-left"><i class="icon icon-chevron-thin-left"></i>prev：<a href="/_/Tech/Angular/pwa-get-started/" rel="prev" title="猜猜我是谁？PWA."> 猜猜我是谁？PWA. </a></span><span class="art-item-right">next：<a href="/_/GVan/hello-game/" rel="next" title="Hello Game"> Hello Game </a><i class="icon icon-chevron-thin-right"></i></span></div></section></article><script>window.subData={title:"Windows服务内存监听",tools:!0}</script></div></div></div><footer id="footer" class="clearfix"><div class="social-wrapper"></div><div>Theme <a href="https://github.com/stkevintan/hexo-theme-material-flow" class="codename">MaterialFlow</a> designed by <a href="https://github.com/stkevintan" target="_blank">Kevin Tan</a>.</div></footer><script>setLoadingBarProgress(80)</script><script src="/js/jquery.min.js"></script><script src="/js/waves.min.js"></script><script src="/js/scrollreveal.min.js"></script><script src="/js/jquery.fitvids.js"></script><script>var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo",ROOT="/";ROOT.endsWith("/")||(ROOT+="/")</script><script src="/js/search.js"></script><script src="/js/app.js"></script><script>setLoadingBarProgress(100)</script></body>